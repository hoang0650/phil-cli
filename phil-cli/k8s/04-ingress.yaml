# --- 1. DEPLOYMENT: AI SANDBOX (Môi trường chạy code) ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ai-sandbox
  namespace: phil-ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ai-sandbox
  template:
    metadata:
      labels:
        app: ai-sandbox
    spec:
      containers:
      - name: sandbox
        image: phil-agent:latest # Image phải được build trước (xem deploy_k8s.sh)
        imagePullPolicy: Never   # Dùng image local nếu chạy k3s/docker
        command: ["tail", "-f", "/dev/null"] # Giữ container chạy
        securityContext:
          privileged: true # QUAN TRỌNG: Cần quyền root để chạy Docker trong Docker
        volumeMounts:
        - mountPath: /workspace
          name: workspace-storage
        - mountPath: /var/run/docker.sock # Mount socket để Sandbox giao tiếp với Host
          name: docker-sock
      volumes:
      - name: workspace-storage
        persistentVolumeClaim:
          claimName: workspace-pvc
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock

---
# --- 2. DEPLOYMENT: API SERVER (Controller trung tâm) ---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: api-server
  namespace: phil-ai
spec:
  replicas: 1
  selector:
    matchLabels:
      app: api-server
  template:
    metadata:
      labels:
        app: api-server
    spec:
      containers:
      - name: api-server
        image: phil-agent:latest
        imagePullPolicy: Never
        # Chạy file server API (FastAPI) thay vì Streamlit UI
        command: ["python3", "src/api_server.py"]
        env:
        # CẤU HÌNH KẾT NỐI SANG CÁC POD AI KHÁC (Dùng tên Service K8s)
        - name: CODER_API_BASE
          value: "http://llm-coder:8000/v1"
        - name: VN_API_BASE
          value: "http://llm-vietnamese:8001/v1"
        - name: VISION_API_BASE
          value: "http://llm-vision:8002/v1"
        - name: STT_API_URL
          value: "http://stt-engine:8000/v1/audio/transcriptions"
        - name: TTS_API_URL
          value: "http://tts-engine:8004/tts/to_audio"
        # CẤU HÌNH WEBHOOK & NODE BACKEND (Lấy từ Secret hoặc gán cứng test)
        - name: WEBHOOK_SECRET
          value: "phil_communication_secret_key_2024"
        - name: NODE_BACKEND_URL
          value: "https://your-node-backend.com/api"
        
        volumeMounts:
        - mountPath: /workspace
          name: workspace-storage
        - mountPath: /var/run/docker.sock
          name: docker-sock
      volumes:
      - name: workspace-storage
        persistentVolumeClaim:
          claimName: workspace-pvc
      - name: docker-sock
        hostPath:
          path: /var/run/docker.sock

---
# --- 3. SERVICE: KẾT NỐI MẠNG (Cầu nối) ---
# Bắt buộc phải có Service thì Ingress mới trỏ vào được
apiVersion: v1
kind: Service
metadata:
  name: api-server
  namespace: phil-ai
spec:
  selector:
    app: api-server
  ports:
    - protocol: TCP
      port: 8080       # Port mở trong K8s
      targetPort: 8080 # Port của container FastAPI

---
# --- 4. INGRESS: CỔNG RA INTERNET ---
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: phil-ingress
  namespace: phil-ai
  annotations:
    # Nếu dùng K3s trên Runpod thì mặc định là traefik
    kubernetes.io/ingress.class: "traefik"
    # Giới hạn Rate Limit (Ví dụ cấu hình cho Traefik)
    traefik.ingress.kubernetes.io/rate-limit: |
        average: 100
        burst: 50
spec:
  rules:
  - http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: api-server # Trỏ về Service đã tạo ở trên
            port:
              number: 8080