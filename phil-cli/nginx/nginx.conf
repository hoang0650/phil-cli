events {
    worker_connections 1024;
}

http {
    # 1. Rate Limiting: Giới hạn mỗi IP chỉ được gọi 10 request/giây (chống DDoS)
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    server {
        listen 80;
        server_name localhost;

        # 2. Security Headers
        add_header X-Frame-Options "SAMEORIGIN";
        add_header X-Content-Type-Options "nosniff";

        # 3. Authentication: Kiểm tra API Key trong Header
        # Client phải gửi header: "Authorization: Bearer YOUR_SECURE_KEY"
        # (Trong thực tế nên dùng Lua script hoặc module auth_request để check DB, 
        # ở đây dùng logic check đơn giản để demo)
        
        # --- ROUTING (Điều hướng) ---
        
        # Brain Coder (Llama-3)
        location /api/coder/ {
            limit_req zone=api_limit burst=20 nodelay;
            # Chỉ cho phép internal network hoặc auth hợp lệ
            proxy_pass http://llm-coder:8000/;
            proxy_set_header Host $host;
            proxy_read_timeout 300s;
        }

        # Language Soul (PhoGPT)
        location /api/language/ {
            limit_req zone=api_limit burst=20 nodelay;
            proxy_pass http://llm-vietnamese:8001/;
        }

        # Vision (Qwen2)
        location /api/vision/ {
            limit_req zone=api_limit burst=10 nodelay;
            proxy_pass http://llm-vision:8002/;
        }

        # Ears (STT)
        location /api/stt/ {
            client_max_body_size 20M; # Cho phép upload file audio tới 20MB
            proxy_pass http://stt-engine:8000/;
        }

        # Mouth (TTS)
        location /api/tts/ {
            proxy_pass http://tts-engine:8004/;
        }
    }
}